{% extends 'base.html' %}
{% block body_class %}match-preview-page{% endblock %}

{% block title %}D√©tail du match{% endblock %}

{% block nav %}
  <a class="nav-button" href="{{ url_for('main.index') }}">‚Üê Retour</a>
{% endblock %}

{% block content %}
{% if match %}
<div class="match-result-card">
  <div class="team team-vertical">
    <img alt="{{ match.home_team }}" class="team-logo-large" src="{{ home_logo }}"/>
    <div class="team-name big">{{ match.home_team }}</div>
  </div>
  <div class="score-block">
    <div class="match-date">{{ match.date[:10] }} {{ match.time or '' }}</div>
    {% if match.home_goals is not none and match.away_goals is not none %}
      <div class="score">{{ match.home_goals }} - {{ match.away_goals }}</div>
      <div class="match-status">TERMIN√â</div>
    {% else %}
      <div class="score">‚Äì</div>
      <div class="match-status">√Ä venir</div>
    {% endif %}
  </div>
  <div class="team team-vertical">
    <img alt="{{ match.away_team }}" class="team-logo-large" src="{{ away_logo }}"/>
    <div class="team-name big">{{ match.away_team }}</div>
  </div>
</div>

<div class="match-panel">
  <div class="player-list-block expanded" id="playerListBlock">
    <div class="scrollable-player-list">
      <table class="player-table">
        <thead>
          <tr>
            <th data-sort="name">Joueur</th>
            <th data-sort="position">Pos</th>
            <th>√âquipe</th>
            <th data-sort="appearances">App.</th>
            <th data-sort="goals">Buts</th>
            <th data-sort="assists">Passes</th>
            <th data-sort="minutes">Min</th>
            <th data-sort="shots_total">Tirs</th>
            <th data-sort="shots_on_target">Cadr√©s</th>
            <th data-sort="goals_per_game">Buts/M</th>
            <th data-sort="assists_per_game">Passes/M</th>
            <th data-sort="minutes_per_game">Min/M</th>
          </tr>
        </thead>
        <tbody>
          {% for player in match.home_players + match.away_players %}
          <tr class="player-item" data-id="{{ player.id }}" data-name="{{ player.name }}">
            <td>{{ player.name }}</td>
            <td>{{ player.position_abbr }}</td>
            <td><img class="small-team-logo" src="{{ player.team_logo }}" alt="logo"/></td>
            <td>{{ player.appearances_detail or player.appearances }}</td>
            <td>{{ player.goals }}</td>
            <td>{{ player.assists }}</td>
            <td>{{ player.minutes }}</td>
            <td>{{ player.shots_total }}</td>
            <td>{{ player.shots_on_target }}</td>
            <td>{{ player.goals_per_game }}</td>
            <td>{{ player.assists_per_game }}</td>
            <td>{{ player.minutes_per_game }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>      
    </div>
  </div>

  <div class="stat-panel collapsed" id="statPanel">
    <button id="togglePanel" class="toggle-panel-btn">üìä Voir les stats <span id="toggle-icon">‚ñº</span></button>
    <div class="stat-content" id="statContent" style="display: none;">
      <h3 id="selected-player-name">Statistiques</h3>
      <div class="form-block" id="player-form" style="display: none;">
        <form id="statForm">
          <div class="stat-button-group" id="stat-buttons"></div>
          <div class="sub-option-group" id="sub-options" style="display: none;"></div>
          <div class="sub-option-group" id="interval-options" style="display: none;"></div>
          <input id="stat" name="stat" type="hidden" value="goals"/>
          <input id="cut" name="cut" type="hidden" value="1"/>
          <input id="filter" name="filter" type="hidden" value=""/>
          <input id="limit" name="limit" type="hidden" value="5"/>
        </form>
      </div>
      <div class="chart-block chart-hidden" id="player-chart" style="display: none;">
        <canvas id="chartCanvas"></canvas>
      </div>
      <div class="performance-slider-wrapper">
        <button class="slider-btn left" id="slider-left">‚Üê</button>
        <div id="performance-cards" class="slider-track"></div>
        <button class="slider-btn right" id="slider-right">‚Üí</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0/dist/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const matchId = {{ match.id | tojson }};
    const toggleBtn = document.getElementById("togglePanel");
  
    toggleBtn.addEventListener("click", () => {
      const isCollapsed = statPanel.classList.contains("collapsed");
  
      statPanel.classList.toggle("collapsed", !isCollapsed);
      statPanel.classList.toggle("expanded", isCollapsed);
      playerListBlock.classList.toggle("collapsed", isCollapsed);
      playerListBlock.classList.toggle("expanded", !isCollapsed);
      statContent.style.display = isCollapsed ? "block" : "none";
  
      const toggleIcon = document.getElementById("toggle-icon");
      toggleIcon.textContent = isCollapsed ? "‚ñ≤" : "‚ñº";
  
      document.body.classList.toggle("chart-visible", isCollapsed);
    });
  
    const statPanel = document.getElementById("statPanel");
    const playerListBlock = document.getElementById("playerListBlock");
    const statContent = document.getElementById("statContent");
    const chartBlock = document.getElementById("player-chart");
    const chartCanvas = document.getElementById("chartCanvas");
    const formBlock = document.getElementById("player-form");
    const playerNameEl = document.getElementById("selected-player-name");
    const playerRows = document.querySelectorAll(".player-item");
    let chart = null;
    let currentPlayerId = null;
  
    const statOptions = {
      goals: [
        { label: "X1", cut: 1, filter: "" },
        { label: "X2", cut: 2, filter: "" },
        { label: "MT", cut: 1, filter: "first_half" },
        { label: "2MT", cut: 1, filter: "both_halves" }
      ],
      assists: [
        { label: "X1", cut: 1, filter: "" },
        { label: "X2", cut: 2, filter: "" }
      ],
      intervalle: [
        { label: "0-15", cut: 1, filter: "0-15" },
        { label: "15-30", cut: 1, filter: "15-30" },
        { label: "30-45", cut: 1, filter: "30-45" },
        { label: "45-60", cut: 1, filter: "45-60" },
        { label: "60-75", cut: 1, filter: "60-75" },
        { label: "75-90", cut: 1, filter: "75-90" }
      ],
      minutes: [
        { label: "30+", cut: 30, filter: "" },
        { label: "60+", cut: 60, filter: "" },
        { label: "90", cut: 90, filter: "" }
      ]
    };
  
    document.getElementById("stat-buttons").innerHTML = Object.keys(statOptions).map(stat =>
      `<button class="stat-btn" data-stat="${stat}" type="button">${stat.charAt(0).toUpperCase() + stat.slice(1)}</button>`
    ).join("");
  
    document.querySelectorAll(".stat-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const stat = btn.dataset.stat;
  
        // üß† correction ici : si "intervalle", on force stat "goals"
        const trueStat = (stat === "intervalle") ? "goals" : stat;
        document.getElementById("stat").value = trueStat;
  
        document.querySelectorAll(".stat-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
  
        const sub = document.getElementById("sub-options");
        sub.innerHTML = "";
  
        const options = statOptions[stat] || [];
        options.forEach(opt => {
          const subBtn = document.createElement("button");
          subBtn.textContent = opt.label;
          subBtn.className = "sub-btn";
          subBtn.type = "button";
          subBtn.onclick = () => {
            document.getElementById("cut").value = opt.cut;
            document.getElementById("filter").value = opt.filter;
  
            document.querySelectorAll(".sub-btn").forEach(b => b.classList.remove("active"));
            subBtn.classList.add("active");
  
            loadChart();
          };
          sub.appendChild(subBtn);
        });
  
        sub.style.display = options.length > 0 ? "block" : "none";
      });
    });
  
    playerRows.forEach((row, i) => {
  row.addEventListener("click", () => {
    playerRows.forEach(r => r.classList.remove("active"));
    row.classList.add("active");
    currentPlayerId = row.dataset.id;
    playerNameEl.textContent = row.dataset.name;
    statPanel.classList.replace("collapsed", "expanded");
    playerListBlock.classList.replace("expanded", "collapsed");
    statContent.style.display = "block";
    formBlock.style.display = "block";
    chartBlock.classList.replace("chart-hidden", "chart-visible");
    chartBlock.style.display = "block";
    chartCanvas.scrollIntoView({ behavior: "smooth" });
    setTimeout(() => { loadChart(); }, 300);
  });
});

let selectedRowIndex = -1;
let loadChartTimeout = null;

document.addEventListener("keydown", (e) => {
  if (["ArrowDown", "ArrowUp"].includes(e.key)) {
    e.preventDefault();
    const rows = Array.from(document.querySelectorAll(".player-item"));

    if (selectedRowIndex === -1) {
      selectedRowIndex = rows.findIndex(row => row.classList.contains("active"));
    }

    if (e.key === "ArrowDown") {
      selectedRowIndex = Math.min(selectedRowIndex + 1, rows.length - 1);
    } else if (e.key === "ArrowUp") {
      selectedRowIndex = Math.max(selectedRowIndex - 1, 0);
    }

    if (rows[selectedRowIndex]) {
      rows.forEach(r => r.classList.remove("active"));
      const row = rows[selectedRowIndex];
      row.classList.add("active");
      currentPlayerId = row.dataset.id;
      playerNameEl.textContent = row.dataset.name;
      statPanel.classList.replace("collapsed", "expanded");
      playerListBlock.classList.replace("expanded", "collapsed");
      statContent.style.display = "block";
      formBlock.style.display = "block";
      chartBlock.classList.replace("chart-hidden", "chart-visible");
      chartBlock.style.display = "block";
      chartCanvas.scrollIntoView({ behavior: "smooth" });

      clearTimeout(loadChartTimeout);
      loadChartTimeout = setTimeout(() => {
        loadChart();
      }, 400);
    }
  }
});

document.getElementById("statForm").addEventListener("submit", e => {
  e.preventDefault();
  loadChart();
});

document.getElementById("slider-left").addEventListener("click", () => {
  document.getElementById("performance-cards").scrollBy({ left: -150, behavior: "smooth" });
});

document.getElementById("slider-right").addEventListener("click", () => {
  document.getElementById("performance-cards").scrollBy({ left: 150, behavior: "smooth" });
});
  
    function loadChart() {
  const stat = document.getElementById("stat").value;
  const cut = parseInt(document.getElementById("cut").value);
  let limit = parseInt(document.getElementById("limit").value);
  if (isNaN(limit) || limit < 1) limit = 5;
  const filter = document.getElementById("filter").value;
  const chartBlock = document.getElementById("player-chart");
  const chartCanvas = document.getElementById("chartCanvas");

  fetch(`/player/${currentPlayerId}/history?stat=${stat}&limit=${limit}&filter=${filter}&cut=${cut}&fixture_id=${matchId}`)
    .then(res => {
      if (!res.ok) throw new Error("Erreur de chargement des donn√©es");
      return res.json();
    })
    .then(data => {
      if (!data.history) {
        console.warn("Aucune donn√©e disponible pour ce joueur");
        return;
      }

      chartBlock.classList.replace("chart-hidden", "chart-visible");
      chartBlock.style.display = "block";

      const labels = data.history.map(m => m.date);
      const values = data.history.map(m => m.value);
      const scores = data.history.map(m => m.score || "");
      const minutes = data.history.map(m => m.minutes || 0);
      const teamInfos = data.history.map(m => ({
        player_team_id: m.player_team_id,
        home_team_id: m.home_team_id,
        away_team_id: m.away_team_id
      }));

      let colors = [];
      if (filter === "first_half") {
        colors = data.history.map(m => {
          if (m.status === "mt") return "#4CAF50";
          if (m.status === "2mt") return "#999999";
          return "#F44336";
        });
      } else {
        colors = data.history.map(m => {
          if (m.value >= cut) return "#4CAF50"; // vert
          if (m.value === 0.1 || m.status === "none") return "#F44336"; // rouge
          return "#ccc"; // gris
        });


      }

      if (chart) chart.destroy();

      chart = new Chart(chartCanvas, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: stat.charAt(0).toUpperCase() + stat.slice(1),
            data: values,
            backgroundColor: colors,
            datalabels: {
              anchor: 'end',
              align: 'start',
              color: '#fff',
              font: context => {
                const count = context.chart.data.labels.length;
                let size = 14;
                if (count > 15) size = 10;
                if (count > 20) size = 8;
                if (count > 25) size = 6;
                return {
                  family: "'Chakra Petch', sans-serif",
                  weight: 'bold',
                  size: size
                };
              },
              formatter: (value, context) => `${minutes[context.dataIndex]}'`
            }
          }],
          scores: scores,
          teams: teamInfos
        },
        options: {
          responsive: true,
          animation: { duration: 400 },
          plugins: {
            tooltip: {
              usePointStyle: true,
              backgroundColor: "#222",
              titleColor: "#f1895c",
              labelTextColor: () => "#fff",
              callbacks: {
                title: (ctx) => {
                  const rawDate = ctx[0].label.split(" ")[0];  // extrait la date
                  const [year, month, day] = rawDate.split("-");
                  return `${day}-${month}-${year}`;
                },
                label: function(context) {
                  const val = context.raw;
                  const idx = context.dataIndex;
                  const score = context.chart.data.scores[idx];
                  const teams = context.chart.data.teams[idx];
                  if (!score || !teams) return [`But : ${val}`];

                  const match = score.match(/^(.+?) (\d+) - (\d+) (.+)$/);
                  if (!match) return [`But : ${val}`, `Score : ${score}`];

                  const [, home, hg, ag, away] = match;
                  const pt = teams.player_team_id;
                  const ht = teams.home_team_id;
                  const at = teams.away_team_id;

                  let formattedScore = "";
                  if (pt === ht) {
                    formattedScore = `${home} [${hg}] - ${ag} ${away}`;
                  } else if (pt === at) {
                    formattedScore = `${home} ${hg} - [${ag}] ${away}`;
                  } else {
                    formattedScore = score;
                  }

                  return [`But : ${val}`, `${formattedScore}`];
                }
              }
            },
            annotation: {
              annotations: {
                cutZone: {
                  type: 'box',
                  yMin: cut + 0.01,
                  yMax: 'max',
                  backgroundColor: 'rgba(100, 100, 100, 0.08)',
                  borderWidth: 0,
                  label: {
                    display: true,
                    content: 'Zone √† atteindre',
                    position: 'start',
                    color: '#666',
                    font: { size: 10 }
                  }
                }
              }
            }
          },
          scales: {
  y: {
    beginAtZero: true,
    suggestedMax: cut >= 1 ? cut + 1 : 1
  },
  x: {
    ticks: {
      callback: function(value, index, ticks) {
        const label = this.getLabelForValue(value);
        const rawDate = label.split(" ")[0]; // Extrait "YYYY-MM-DD"
        const [year, month, day] = rawDate.split("-");
        return `${day}-${month}-${year}`; // ‚ûú DD-MM-YYYY
      },
      font: {
        family: "'Chakra Petch', sans-serif",
        size: 12
      }
    }
  }
}
        },
        plugins: [ChartDataLabels, Chart.registry.getPlugin('annotation')]
      });
    // ‚úÖ Bloc des cartes de performance
const perf = data.performance;
const cards = [
  { label: "Ls 5", value: perf.last_5 },
  { label: "Ls 10", value: perf.last_10 },
  { label: "Ls 20", value: perf.last_20 },
  { label: "H2H", value: perf.h2h },
  { label: "Dom", value: perf.home },
  { label: "Ext", value: perf.away },
  { label: "Saison", value: perf.season }
];

const container = document.getElementById("performance-cards");
container.innerHTML = "";
const currentLimit = limit;

cards.forEach(card => {
  const div = document.createElement("div");
  div.className = "performance-card";
  let ratio = "-", percent = "-";
  if (card.value && typeof card.value === "string") {
    const match = card.value.match(/(\d+\/\d+)\s\((\d+)%\)/);
    if (match) [ratio, percent] = match.slice(1);
  }

  div.innerHTML = `
    <div class="card-top"><span class="card-label">${card.label}</span></div>
    <div class="card-main"><span class="card-percent">${percent !== "-" ? percent + "%" : "-"}</span></div>
    <div class="card-sub">${ratio || "-"}</div>
  `;

  if (card.label.startsWith("Ls")) {
    const limitValue = parseInt(card.label.replace("Ls ", "")) || 5;
    div.style.cursor = "pointer";
    if (limitValue === currentLimit) div.classList.add("active");
    div.addEventListener("click", () => {
      document.getElementById("limit").value = limitValue;
      document.querySelectorAll(".performance-card").forEach(c => {
        if (c.querySelector(".card-label")?.textContent.startsWith("Ls")) {
          c.classList.remove("active");
        }
      });
      div.classList.add("active");
      loadChart();
    });
  }

  container.appendChild(div);
});

    })
    .catch(err => {
      console.error("Erreur lors du chargement du graphique :", err);
    });
}


  
    const table = document.querySelector(".player-table");
    const tbody = table.querySelector("tbody");
    const headers = table.querySelectorAll("th[data-sort]");
    let sortDirection = -1;
    let activeSortKey = "goals";
  
    const defaultDescending = ["goals", "assists", "minutes", "shots_total", "shots_on_target", "goals_per_game", "assists_per_game", "minutes_per_game"];
  
    headers.forEach(th => {
      th.style.cursor = "pointer";
      th.addEventListener("click", () => {
        const key = th.dataset.sort;
        const colIndex = th.cellIndex;
        const rows = Array.from(tbody.querySelectorAll("tr"));
      
        const getValue = row => {
          const cell = row.cells[colIndex];
          const text = cell.textContent.trim();
          const num = parseFloat(text.replace(",", "."));
          return isNaN(num) ? text.toLowerCase() : num;
        };
      
        if (activeSortKey === key) {
          sortDirection *= -1;
        } else {
          activeSortKey = key;
          sortDirection = defaultDescending.includes(key) ? -1 : 1;
        }
      
        document.querySelectorAll(".player-table th, .player-table td").forEach(cell => {
          cell.classList.remove("sorted-col");
        });
      
        th.classList.add("sorted-col");
        rows.forEach(row => {
          if (row.cells[colIndex]) {
            row.cells[colIndex].classList.add("sorted-col");
          }
        });
      
        rows.sort((a, b) => {
          const valA = getValue(a);
          const valB = getValue(b);
          return valA > valB ? sortDirection : valA < valB ? -sortDirection : 0;
        });
      
        rows.forEach(row => tbody.appendChild(row));
      });
      // ‚ûï Tri automatique au chargement sur "Buts"
const defaultHeader = document.querySelector('th[data-sort="goals"]');
if (defaultHeader) defaultHeader.click();
    }); // ‚úÖ une seule fermeture ici
  }); // ‚úÖ FIN de document.addEventListener("DOMContentLoaded", ...)
</script>
  
{% else %}
<p>‚ö†Ô∏è Match introuvable.</p>
{% endif %}
{% endblock %}
